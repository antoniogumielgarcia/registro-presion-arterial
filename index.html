<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Presi√≥n Arterial</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
    <!-- Chart.js CDN para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- jsPDF CDN para la exportaci√≥n a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-6 border-b-4 border-indigo-200 pb-2">
            Control de Tensi√≥n Arterial ü©∫
        </h1>

        <!-- Contenedor Principal: Input, Recordatorio y Gr√°fico -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Columna de Entrada de Datos y Recordatorios -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Tarjeta de Programaci√≥n de Calendario (VISUALMENTE PRIMERO) -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border-t-8 border-red-500 transition duration-300 hover:shadow-red-200">
                    <h2 class="text-2xl font-bold mb-4 text-red-600 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-4 9h.01M3 21h18a2 2 0 002-2V7a2 2 0 00-2-2H3a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        1. Programar Recordatorio en Calendario
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Establece cu√°ndo y con qu√© frecuencia deseas tomar tu tensi√≥n.</p>
                    <form id="reminder-form" class="space-y-4">
                        <div>
                            <label for="reminder-time" class="block text-sm font-medium text-gray-700">Hora de Toma Diaria</label>
                            <input type="time" id="reminder-time" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-red-500 focus:ring-red-500 transition duration-150">
                        </div>
                        <div>
                            <label for="reminder-days" class="block text-sm font-medium text-gray-700">Recurrencia (Cada X d√≠as)</label>
                            <input type="number" id="reminder-days" min="1" max="365" value="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-red-500 focus:ring-red-500 transition duration-150">
                        </div>
                        <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 font-bold">
                            Guardar Configuraci√≥n
                        </button>
                    </form>
                    
                    <div id="reminder-output" class="mt-4 p-3 rounded-lg text-sm bg-red-50 border border-red-200">
                        <p id="reminder-status" class="text-red-700 font-bold mb-2">Recordatorio no establecido.</p>
                        <a id="calendar-link" href="#" target="_blank" class="hidden w-full inline-flex items-center justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 mt-2">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-4 9h.01M3 21h18a2 2 0 002-2V7a2 2 0 00-2-2H3a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Abrir en Google Calendar
                        </a>
                        <p id="calendar-info" class="text-xs text-red-500 mt-2 hidden">
                            IMPORTANTE: Haz clic en el bot√≥n y **configura la repetici√≥n** cada X d√≠as dentro de tu calendario.
                        </p>
                    </div>
                </div>

                <!-- Tarjeta de Entrada de Lectura (Ahora es el punto 2) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">2. Registrar Nueva Lectura</h2>
                    <form id="reading-form" class="space-y-4">
                        <div>
                            <label for="systolic" class="block text-sm font-medium text-gray-700">Presi√≥n Sist√≥lica (M√°x)</label>
                            <input type="number" id="systolic" placeholder="Ej: 120" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="diastolic" class="block text-sm font-medium text-gray-700">Presi√≥n Diast√≥lica (M√≠n)</label>
                            <input type="number" id="diastolic" placeholder="Ej: 80" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                        </div>
                        <div>
                            <label for="pulse" class="block text-sm font-medium text-gray-700">Pulso (BPM)</label>
                            <input type="number" id="pulse" placeholder="Ej: 75" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                        </div>
                        <button type="submit" id="save-reading-btn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 font-bold">
                            Guardar Lectura
                        </button>
                        <div id="save-status" class="text-sm pt-2 text-center hidden"></div>
                    </form>
                </div>
                
            </div>

            <!-- Columna de Gr√°fico e Historial -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Tarjeta de Gr√°fico de Evoluci√≥n -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">3. Gr√°fico de Evoluci√≥n</h2>
                    <div class="h-80 relative">
                        <canvas id="bpChart"></canvas>
                    </div>
                </div>

                <!-- Tarjeta de Historial y Exportaci√≥n -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">4. Historial Completo</h2>
                        <button id="export-pdf-btn" class="py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Exportar a PDF
                        </button>
                    </div>
                    
                    <div class="scroll-container border rounded-lg">
                        <table id="readings-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sist√≥lica</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Diast√≥lica</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pulso</th>
                                </tr>
                            </thead>
                            <tbody id="readings-body" class="bg-white divide-y divide-gray-200">
                                <!-- Las lecturas se insertar√°n aqu√≠ -->
                                <tr><td colspan="4" class="text-center py-4 text-gray-500">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- Setup de Firebase y Autenticaci√≥n ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        
        // =====================================================================
        // --- Configuraci√≥n de Firebase: ¬°EDITAR OBLIGATORIO! ---
        // =====================================================================
        // 1. Verifica que 'appId' coincida con tu estructura de Firebase.
        const appId = 'blood-pressure-tracker'; 
        
        // 2. REEMPLAZA el objeto 'firebaseConfig' con la configuraci√≥n de TU proyecto.
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDKyG2iJlbN0g-jg0iRNZ49iyR1AQeyLQg",
  authDomain: "presion-arterial-3cc4f.firebaseapp.com",
  projectId: "presion-arterial-3cc4f",
  storageBucket: "presion-arterial-3cc4f.firebasestorage.app",
  messagingSenderId: "989689849352",
  appId: "1:989689849352:web:683f809e8acf0fd3d813bd"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);            // Pega tu configuraci√≥n aqu√≠ (ej: apiKey, authDomain, projectId, etc.)
            // Si la aplicaci√≥n funciona aqu√≠, significa que esta variable est√° siendo
            // llenada por el entorno de Canvas. Para GitHub Pages, ¬°debes pegarla manualmente!
            // Ejemplo de estructura (no usar, es ficticia):
            /*
            apiKey: "TU_API_KEY",
            authDomain: "TU_DOMINIO.firebaseapp.com",
            projectId: "TU_ID_DE_PROYECTO",
            // ... resto de la configuraci√≥n ...
            */
            // Usamos un placeholder para que funcione en el Canvas, pero DEBE CAMBIARSE:
            // eslint-disable-next-line no-undef
            ...(typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {})
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // =====================================================================
        // --- FIN DE LA CONFIGURACI√ìN (No tocar el resto del script) ---
        // =====================================================================
        

        // Variables de la Aplicaci√≥n
        let db;
        let auth;
        let userId = null;
        let chartInstance = null;
        let allReadings = []; 

        // Elementos del DOM
        const readingForm = document.getElementById('reading-form');
        const reminderForm = document.getElementById('reminder-form');
        const readingsBody = document.getElementById('readings-body');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const reminderStatus = document.getElementById('reminder-status');
        const calendarLink = document.getElementById('calendar-link');
        const calendarInfo = document.getElementById('calendar-info');
        const saveStatus = document.getElementById('save-status');
        const reminderTimeInput = document.getElementById('reminder-time');
        const reminderDaysInput = document.getElementById('reminder-days');


        // --- FUNCIONES DE UTILIDAD Y CORE ---

        /**
         * Inicializa Firebase, autentica al usuario y comienza a escuchar los datos.
         */
        async function initializeAppAndAuth() {
            try {
                // setLogLevel('error'); // Mantener en "error" para producci√≥n
                
                // Comprueba si firebaseConfig es un objeto v√°lido con al menos projectId
                const isConfigValid = firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId;
                
                if (!isConfigValid) {
                    console.error("Configuraci√≥n de Firebase no disponible o incompleta. Por favor, edita el script para insertar tus credenciales.");
                    readingsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500 font-bold">ERROR: Configura tus credenciales de Firebase en el c√≥digo.</td></tr>';
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    // Si estamos en el entorno Canvas, usamos el token de inicio
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // En GitHub Pages, usamos inicio de sesi√≥n an√≥nimo
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado. ID:", userId);
                        
                        loadReadings();
                        loadReminder();
                    } else {
                        console.error("No se pudo autenticar al usuario.");
                        readingsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error de autenticaci√≥n.</td></tr>';
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                readingsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al conectar con la base de datos. Verifica tu conexi√≥n o las credenciales de Firebase.</td></tr>';
            }
        }

        /**
         * Guarda una nueva lectura de tensi√≥n arterial en Firestore.
         */
        async function saveReading(systolic, diastolic, pulse) {
            if (!userId || !db) {
                console.error("Error: Usuario o DB no autenticada/disponible.");
                return;
            }

            // Ruta privada: /artifacts/{appId}/users/{userId}/blood_pressure_readings
            const readingsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'blood_pressure_readings');
            
            try {
                await addDoc(readingsCollectionRef, {
                    systolic: Number(systolic),
                    diastolic: Number(diastolic),
                    pulse: Number(pulse),
                    timestamp: serverTimestamp() 
                });
                
                saveStatus.textContent = '¬°Lectura guardada con √©xito!';
                saveStatus.className = 'text-sm pt-2 text-center text-green-600 font-medium block';
                readingForm.reset();
            } catch (error) {
                // Este error suele indicar REGLAS DE SEGURIDAD incorrectas
                console.error("Error al guardar la lectura:", error);
                saveStatus.textContent = 'Error al guardar. ¬øReglas de Seguridad de Firestore publicadas?';
                saveStatus.className = 'text-sm pt-2 text-center text-red-600 font-medium block';
            }
            setTimeout(() => { saveStatus.classList.add('hidden'); }, 3000);
        }

        /**
         * Escucha los datos en tiempo real (onSnapshot) y actualiza la tabla y el gr√°fico.
         */
        function loadReadings() {
            if (!userId || !db) return;

            const readingsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'blood_pressure_readings');
            const readingsQuery = query(readingsCollectionRef); 

            onSnapshot(readingsQuery, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => {
                    // Si el timestamp es nulo (por ser un objeto ServerTimestamp pendiente), usa la fecha actual temporalmente
                    const timestamp = doc.data().timestamp ? doc.data().timestamp.toDate() : new Date();
                    data.push({ id: doc.id, ...doc.data(), date: timestamp });
                });

                data.sort((a, b) => b.date.getTime() - a.date.getTime());
                allReadings = data; 
                
                renderTable(data);
                renderChart(data);
            }, (error) => {
                console.error("Error al escuchar los datos:", error);
                readingsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al cargar el historial. ¬°Revisa las Reglas de Seguridad!</td></tr>';
            });
        }

        /**
         * Renderiza la tabla de historial.
         */
        function renderTable(data) {
            readingsBody.innerHTML = '';
            if (data.length === 0) {
                readingsBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">A√∫n no hay lecturas registradas.</td></tr>';
                exportPdfBtn.disabled = true;
                exportPdfBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            exportPdfBtn.disabled = false;
            exportPdfBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            data.forEach(reading => {
                const dateStr = reading.date.toLocaleString('es-ES', { 
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
                const row = `
                    <tr class="hover:bg-indigo-50 transition duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dateStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${reading.systolic}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${reading.diastolic}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${reading.pulse}</td>
                    </tr>
                `;
                readingsBody.innerHTML += row;
            });
        }

        /**
         * Renderiza o actualiza el gr√°fico de evoluci√≥n con Chart.js.
         */
        function renderChart(data) {
            // Clonar y ordenar por fecha ASCENDENTE para el gr√°fico (de m√°s antiguo a m√°s nuevo)
            const sortedData = [...data].sort((a, b) => a.date.getTime() - a.date.getTime());

            const labels = sortedData.map(d => 
                d.date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }) + 
                ' ' + 
                d.date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
            );
            const systolicValues = sortedData.map(d => d.systolic);
            const diastolicValues = sortedData.map(d => d.diastolic);
            const pulseValues = sortedData.map(d => d.pulse); 

            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = systolicValues;
                chartInstance.data.datasets[1].data = diastolicValues;
                chartInstance.data.datasets[2].data = pulseValues; 
                chartInstance.update();
                return;
            }

            const ctx = document.getElementById('bpChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sist√≥lica',
                            data: systolicValues,
                            borderColor: '#4f46e5', // √çndigo
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 5
                        },
                        {
                            label: 'Diast√≥lica',
                            data: diastolicValues,
                            borderColor: '#10b981', // Verde esmeralda
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 5
                        },
                        // L√çNEA PARA EL PULSO
                        {
                            label: 'Pulso (BPM)', 
                            data: pulseValues,
                            borderColor: '#f59e0b', // √Åmbar (Naranja)
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                // T√≠tulo de eje Y actualizado para incluir BPM
                                text: 'Valores (mmHg / BPM)' 
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha y Hora'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Evoluci√≥n de la Presi√≥n Arterial y Pulso' // T√≠tulo del gr√°fico actualizado
                        }
                    }
                }
            });
        }

        /**
         * Carga la configuraci√≥n del recordatorio desde Firestore y genera el enlace.
         */
        function loadReminder() {
            if (!userId || !db) return;
            // Ruta para la configuraci√≥n: /artifacts/{appId}/users/{userId}/settings/bp_tracker_settings
            const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'bp_tracker_settings');
            
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const reminderTime = data.reminderTime || '';
                    const reminderDays = data.reminderDays || 1;

                    reminderTimeInput.value = reminderTime;
                    reminderDaysInput.value = reminderDays;
                    
                    if (reminderTime) {
                        generateCalendarLink(reminderTime, reminderDays);

                        let statusText = `Hora de recordatorio guardada: ${reminderTime}.`;
                        if (reminderDays > 1) {
                             statusText += ` Frecuencia: Cada ${reminderDays} d√≠as.`;
                        } else {
                            statusText += ` Frecuencia: Diaria.`;
                        }
                        reminderStatus.textContent = statusText;

                    } else {
                        reminderStatus.textContent = 'Hora de recordatorio no establecida.';
                        calendarLink.classList.add('hidden');
                        calendarInfo.classList.add('hidden');
                    }
                } else {
                    reminderStatus.textContent = 'Hora de recordatorio no establecida.';
                    calendarLink.classList.add('hidden');
                    calendarInfo.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error al cargar la hora de recordatorio:", error);
            });
        }

        /**
         * Genera la URL para crear un evento en Google Calendar.
         */
        function generateCalendarLink(timeString, days) {
            const [hours, minutes] = timeString.split(':');
            
            // Usamos la fecha de ma√±ana para el evento inicial
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const startYear = tomorrow.getFullYear();
            const startMonth = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const startDay = String(tomorrow.getDate()).padStart(2, '0');
            const startHour = hours.padStart(2, '0');
            const startMinute = minutes.padStart(2, '0');
            
            const dateTimeStart = `${startYear}${startMonth}${startDay}T${startHour}${startMinute}00`;
            
            let endHour = Number(hours);
            let endMinute = Number(minutes) + 5; // Evento de 5 minutos
            if (endMinute >= 60) {
                endMinute -= 60;
                endHour += 1;
            }
            const endHourStr = String(endHour).padStart(2, '0');
            const endMinuteStr = String(endMinute).padStart(2, '0');
            
            const dateTimeEnd = `${startYear}${startMonth}${startDay}T${endHourStr}${endMinuteStr}00`;

            const title = encodeURIComponent("‚è∞ TOMA DE TENSI√ìN ARTERIAL");
            
            let detailsText = `Es hora de registrar tu presi√≥n arterial (Sist√≥lica, Diast√≥lica y Pulso) en la aplicaci√≥n.`;
            if (days > 1) {
                detailsText += `\n\nATENCI√ìN: Configura este evento para que se repita CADA ${days} D√çAS en tu calendario.`;
            } else {
                detailsText += `\n\nATENCI√ìN: Configura este evento para que se repita DIARIAMENTE.`;
            }

            const details = encodeURIComponent(detailsText);
            const location = encodeURIComponent("Aplicaci√≥n de Control de Tensi√≥n Arterial");

            // URL para Google Calendar
            const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${dateTimeStart}/${dateTimeEnd}&sf=true&output=xml`;

            calendarLink.href = googleCalendarUrl;
            calendarLink.classList.remove('hidden');
            calendarInfo.classList.remove('hidden');
        }

        /**
         * Exporta el historial completo a un documento PDF.
         */
        function exportToPDF() {
            if (allReadings.length === 0) {
                saveStatus.textContent = 'No hay datos para exportar a PDF.';
                saveStatus.className = 'text-sm pt-2 text-center text-red-600 font-medium block';
                setTimeout(() => { saveStatus.classList.add('hidden'); }, 3000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.setTextColor(50, 50, 50);
            doc.text("Historial de Presi√≥n Arterial", 14, 22);

            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text(`Generado el: ${new Date().toLocaleString('es-ES')}`, 14, 30);
            doc.text(`ID de Usuario: ${userId}`, 14, 35);
            
            // Preparar datos para la tabla
            const headers = [
                ["Fecha/Hora", "Sist√≥lica (mmHg)", "Diast√≥lica (mmHg)", "Pulso (BPM)"]
            ];
            const data = allReadings.map(r => [
                r.date.toLocaleString('es-ES'),
                r.systolic.toString(),
                r.diastolic.toString(),
                r.pulse.toString()
            ]);

            // Agregar la tabla al PDF
            doc.autoTable({
                startY: 45,
                head: headers,
                body: data,
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [79, 70, 229] }, 
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 10, left: 14, right: 14, bottom: 10 },
            });

            // Guardar el PDF
            doc.save(`Historial_PA_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // --- MANEJADORES DE EVENTOS ---

        readingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            const pulse = document.getElementById('pulse').value;
            
            if (systolic && diastolic && pulse) {
                saveReading(systolic, diastolic, pulse);
            }
        });

        reminderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !db) {
                reminderStatus.textContent = "Error: La aplicaci√≥n no est√° lista o Firebase no est√° configurado.";
                reminderStatus.className = 'text-red-700 font-bold';
                return;
            }
            const reminderTime = reminderTimeInput.value;
            const reminderDays = parseInt(reminderDaysInput.value, 10);

            if (!reminderTime || isNaN(reminderDays) || reminderDays < 1) {
                reminderStatus.textContent = 'Por favor, introduce una hora y un n√∫mero de d√≠as v√°lido (m√≠nimo 1).';
                reminderStatus.className = 'text-red-700 font-bold';
                return;
            }

            const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'bp_tracker_settings');
            
            try {
                // 1. Guardar la hora y la frecuencia en Firestore
                await setDoc(settingsDocRef, { 
                    reminderTime: reminderTime,
                    reminderDays: reminderDays 
                }, { merge: true });
                
                // 2. Generar el enlace de calendario
                generateCalendarLink(reminderTime, reminderDays);
                
                // 3. Mostrar estado
                let statusText = `Hora de recordatorio guardada: ${reminderTime}. Frecuencia: Cada ${reminderDays} d√≠as.`;
                if (reminderDays === 1) statusText = `Hora de recordatorio guardada: ${reminderTime}. Frecuencia: Diaria.`;
                
                reminderStatus.textContent = statusText;
                
            } catch (error) {
                console.error("Error al establecer el recordatorio:", error);
                reminderStatus.textContent = 'Error al guardar la configuraci√≥n. Intenta de nuevo.';
                reminderStatus.className = 'text-red-700 font-bold';
            }
        });

        exportPdfBtn.addEventListener('click', exportToPDF);
        
        // Carga inicial
        initializeAppAndAuth();
    </script>
    <!-- Importar autoTable para jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
