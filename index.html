<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Tensión Arterial (Local)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Carga de jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    
    <style>
        /* Configuración personalizada de Tailwind */
        :root {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 600px;
        }
        .chart-container {
            height: 300px;
        }
        .scrollable-table {
            max-height: 250px;
            overflow-y: auto;
        }
        .active-tab {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="bg-gray-50 p-4 min-h-screen">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mt-2 mb-2">Monitor de Tensión Arterial (Local)</h1>
        <p class="text-center text-sm text-gray-600 mb-6">Datos guardados solo en tu dispositivo. Se genera un JSON de respaldo automático al guardar.</p>

        <!-- Pestañas de Navegación -->
        <div class="flex border-b border-indigo-200 mb-6">
            <button onclick="window.showSection('registro')" class="tab-button tab-registro flex-1 py-3 text-center text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition duration-150 active-tab">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                Registrar (3 Tomas)
            </button>
            <button onclick="window.showSection('grafico')" class="tab-button tab-grafico flex-1 py-3 text-center text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                Gráfico
            </button>
            <button onclick="window.showSection('historial')" class="tab-button tab-historial flex-1 py-3 text-center text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-400 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-4 5h4m-4 4h4m-6-4h.01M9 16h.01" /></svg>
                Historial
            </button>
        </div>

        <!-- SECCIÓN 1: REGISTRO DE DATOS -->
        <div id="registro" class="section">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <form id="registroForm" class="space-y-6">

                    <!-- Cabecera de Tomas -->
                    <div class="grid grid-cols-4 gap-2 text-center text-xs font-semibold text-indigo-700 bg-indigo-50 p-2 rounded-lg shadow-inner">
                        <div class="col-span-1 text-left pl-1">Métrica</div>
                        <div class="col-span-1">Toma 1</div>
                        <div class="col-span-1">Toma 2</div>
                        <div class="col-span-1">Toma 3</div>
                    </div>

                    <!-- Tensión Sistólica (Máxima) -->
                    <div class="grid grid-cols-4 gap-2 items-center">
                        <label class="col-span-1 text-sm font-medium text-gray-700">Sistólica (mmHg)</label>
                        <input type="number" data-type="systolic" data-index="1" placeholder="1er" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                        <input type="number" data-type="systolic" data-index="2" placeholder="2do" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                        <input type="number" data-type="systolic" data-index="3" placeholder="3er" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                    </div>

                    <!-- Tensión Diastólica (Mínima) -->
                    <div class="grid grid-cols-4 gap-2 items-center">
                        <label class="col-span-1 text-sm font-medium text-gray-700">Diastólica (mmHg)</label>
                        <input type="number" data-type="diastolic" data-index="1" placeholder="1er" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                        <input type="number" data-type="diastolic" data-index="2" placeholder="2do" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                        <input type="number" data-type="diastolic" data-index="3" placeholder="3er" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                    </div>

                    <!-- Pulso (Latidos por minuto) -->
                    <div class="grid grid-cols-4 gap-2 items-center">
                        <label class="col-span-1 text-sm font-medium text-gray-700">Pulso (lpm)</label>
                        <input type="number" data-type="pulse" data-index="1" placeholder="1er" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                        <input type="number" data-type="pulse" data-index="2" placeholder="2do" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                        <input type="number" data-type="pulse" data-index="3" placeholder="3er" required class="col-span-1 w-full rounded-lg shadow-sm p-2 text-sm border border-gray-300 focus:border-indigo-500">
                    </div>

                    <!-- Promedios Calculados (Solo lectura) -->
                    <div class="grid grid-cols-4 gap-2 items-center pt-2 border-t border-indigo-200">
                        <label class="col-span-1 text-sm font-bold text-indigo-700">Media</label>
                        <div id="avgSystolicDisplay" class="col-span-1 text-center font-bold text-lg text-indigo-600">-</div>
                        <div id="avgDiastolicDisplay" class="col-span-1 text-center font-bold text-lg text-indigo-600">-</div>
                        <div id="avgPulseDisplay" class="col-span-1 text-center font-bold text-lg text-indigo-600">-</div>
                    </div>

                    <!-- Fecha y Hora -->
                    <div class="pt-4">
                        <label for="dateTime" class="block text-sm font-medium text-gray-700">Fecha y Hora del Registro (Media)</label>
                        <input type="datetime-local" id="dateTime" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                    </div>

                    <button type="submit" id="saveRecordBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 disabled:opacity-50" disabled>
                        Guardar Media y Exportar Backup JSON
                    </button>
                </form>
                <div id="messageBox" class="mt-4 p-3 rounded-lg text-center hidden"></div>
            </div>
        </div>

        <!-- SECCIÓN 2: GRÁFICO DE EVOLUCIÓN -->
        <div id="grafico" class="section hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">Evolución (Últimos 30 Registros)</h2>
                <div class="chart-container">
                    <canvas id="pressureChart"></canvas>
                </div>
                <div id="noDataChart" class="hidden text-center text-gray-500 py-10">
                    No hay suficientes datos para generar el gráfico. ¡Añade tu primer registro!
                </div>
            </div>
        </div>

        <!-- SECCIÓN 3: HISTORIAL Y EXPORTACIÓN -->
        <div id="historial" class="section hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">Historial de Registros (Local)</h2>

                <!-- Control de Importación y Exportación JSON Manual -->
                <div class="mb-6 p-4 border border-green-200 rounded-lg bg-green-50/50">
                    <p class="text-sm font-bold text-green-700 mb-2">Copia de Seguridad (JSON)</p>
                    <p class="text-xs text-green-600 mb-3">El backup automático se descarga cada vez que guardas un registro nuevo con el nombre: <code>backup_tension_arterial_[FECHA]_[HORA].json</code>. Búscalo en tu carpeta de **Descargas**.</p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <!-- Exportar JSON Manual -->
                        <button id="exportJsonButton" onclick="window.exportToJson()" class="flex-1 flex items-center justify-center py-2 px-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150 disabled:opacity-50" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Exportar JSON (Manual)
                        </button>
                        <!-- Importar JSON -->
                        <label for="importJsonInput" class="flex-1 flex items-center justify-center py-2 px-3 border border-green-600 rounded-lg shadow-sm text-sm font-medium text-green-600 hover:bg-green-100 transition duration-150 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            Importar JSON
                            <input type="file" id="importJsonInput" accept=".json" class="hidden" onchange="window.handleJsonImport(event)">
                        </label>
                    </div>
                </div>
                
                <!-- Selección de Rango de Fechas para Exportación PDF -->
                <div class="flex flex-col sm:flex-row gap-4 mb-6 p-4 border border-indigo-200 rounded-lg bg-indigo-50/50">
                    <div class="flex-1">
                        <label for="startDate" class="block text-xs font-medium text-gray-700 mb-1">Exportar desde (opcional):</label>
                        <input type="date" id="startDate" class="block w-full rounded-lg border-indigo-300 shadow-sm p-2 text-sm border">
                    </div>
                    <div class="flex-1">
                        <label for="endDate" class="block text-xs font-medium text-gray-700 mb-1">Exportar hasta (opcional):</label>
                        <input type="date" id="endDate" class="block w-full rounded-lg border-indigo-300 shadow-sm p-2 text-sm border">
                    </div>
                </div>

                <!-- Contenedor de la tabla con scroll -->
                <div class="scrollable-table mb-4 border border-gray-200 rounded-lg shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Fecha</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Sistólica</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Diastólica</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Pulso</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-100 text-sm">
                            <!-- Los datos se insertarán aquí por JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="noDataHistory" class="text-center text-gray-500 py-4 hidden">
                    Aún no tienes registros guardados localmente.
                </div>

                <button id="exportPdfButton" onclick="window.exportToPdf()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 mt-4 disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Exportar Registros Filtrados a PDF
                </button>
            </div>
        </div>

        <!-- Modal personalizado -->
        <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h3 id="modalTitle" class="text-lg font-semibold text-indigo-700 mb-4">Confirmación</h3>
                <p id="modalMessage" class="text-sm text-gray-600 mb-6">¿Estás seguro de que quieres realizar esta acción?</p>
                <div id="modalButtons" class="flex justify-end space-x-3">
                    <!-- Los botones se insertan dinámicamente -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        const LOCAL_STORAGE_KEY = 'bloodPressureRecords';
        let pressureData = [];
        let pressureChart = null;

        // Definición de las funciones en window para que sean accesibles globalmente
        window.showSection = showSection;
        window.deleteRecord = deleteRecord;
        window.exportToPdf = exportToPdf;
        window.exportToJson = exportToJson;
        window.handleJsonImport = handleJsonImport;

        // --- GESTIÓN DE DATOS LOCALES (localStorage) ---

        /**
         * Genera un identificador único global (UUID) para cada registro.
         */
        function generateUUID() {
            return crypto.randomUUID();
        }

        /**
         * Carga los datos desde localStorage y los parsea.
         */
        function loadDataFromLocal() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                try {
                    pressureData = JSON.parse(storedData);
                    // Asegurar que el array esté ordenado del más reciente al más antiguo
                    pressureData.sort((a, b) => new Date(b.date) - new Date(a.date));
                } catch (e) {
                    console.error("Error al parsear datos de localStorage:", e);
                    pressureData = [];
                }
            } else {
                pressureData = [];
            }
            
            // Actualizar UI al cargar
            updateUIBasedOnData();
        }

        /**
         * Guarda el array global 'pressureData' en localStorage.
         */
        function saveDataToLocal() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pressureData));
            updateUIBasedOnData();
        }

        /**
         * Añade un nuevo registro a 'pressureData', guarda en local y dispara la exportación.
         * @param {object} record - El objeto de registro a guardar.
         */
        function addRecordToLocal(record) {
            // Añadir ID único local
            const newRecord = { ...record, id: generateUUID() };
            pressureData.unshift(newRecord); // Añadir al principio (más reciente)
            
            saveDataToLocal();
            
            showMessage(`Registro de Media (${record.systolic}/${record.diastolic}) guardado localmente con éxito.`, 'success');
            
            // *** EXPORTACIÓN AUTOMÁTICA ***
            exportToJson(true); 
        }

        /**
         * Elimina un registro de 'pressureData' por su ID y guarda.
         * @param {string} id - El ID del registro a eliminar.
         */
        function deleteRecordFromLocal(id) {
            const initialLength = pressureData.length;
            pressureData = pressureData.filter(record => record.id !== id);
            
            if (pressureData.length < initialLength) {
                saveDataToLocal();
                showMessage("Registro de media eliminado localmente.", 'success');
            } else {
                showMessage("Error: Registro no encontrado para eliminar.", 'error');
            }
        }

        /**
         * Actualiza el gráfico y la tabla del historial.
         */
        function updateUIBasedOnData() {
            renderHistoryTable();
            renderChart();

            // Habilitar/Deshabilitar botones de exportar si hay datos
            const hasData = pressureData.length > 0;
            document.getElementById('exportPdfButton').disabled = !hasData;
            document.getElementById('exportJsonButton').disabled = !hasData;
        }


        // --- MANEJO DE UI Y ESTADO ---

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(sec => sec.classList.add('hidden'));

            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.classList.remove('active-tab', 'border-indigo-600', 'text-indigo-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            const targetTab = document.querySelector(`.tab-${sectionId}`);
            if (targetTab) {
                 targetTab.classList.add('active-tab', 'border-indigo-600', 'text-indigo-600');
                 targetTab.classList.remove('border-transparent', 'text-gray-500');
            }

            // Recargar contenido específico al cambiar de sección
            if (sectionId === 'grafico') {
                renderChart();
            } else if (sectionId === 'historial') {
                renderHistoryTable();
            }
        }

        function showMessage(message, type) {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = message;
            msgBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');

            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                msgBox.classList.add('bg-red-100', 'text-red-800');
            }

            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 5000); // 5 segundos para que el usuario pueda leer
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            if (isNaN(date)) return 'Fecha Inválida';

            const d = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const t = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            return `${d} ${t}`;
        }

        // --- MANEJO DE FORMULARIO Y DATOS ---

        function setInitialDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('dateTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function calculateAverage(values) {
            const sum = values.reduce((acc, val) => acc + val, 0);
            return Math.round(sum / values.length);
        }

        function calculateAndDisplayAverages() {
            const inputs = document.querySelectorAll('#registroForm input[type="number"]');
            const readings = { systolic: [], diastolic: [], pulse: [] };
            let allValid = true;

            inputs.forEach(input => {
                const type = input.dataset.type;
                const value = parseInt(input.value);

                if (isNaN(value) || value <= 0) {
                    allValid = false;
                    return;
                }
                if (type) {
                    readings[type].push(value);
                }
            });

            const avgSystolicDisplay = document.getElementById('avgSystolicDisplay');
            const avgDiastolicDisplay = document.getElementById('avgDiastolicDisplay');
            const avgPulseDisplay = document.getElementById('avgPulseDisplay');
            const saveButton = document.getElementById('saveRecordBtn');

            if (allValid && readings.systolic.length === 3 && readings.diastolic.length === 3 && readings.pulse.length === 3) {
                const avgSystolic = calculateAverage(readings.systolic);
                const avgDiastolic = calculateAverage(readings.diastolic);
                const avgPulse = calculateAverage(readings.pulse);

                avgSystolicDisplay.textContent = avgSystolic;
                avgDiastolicDisplay.textContent = avgDiastolic;
                avgPulseDisplay.textContent = avgPulse;
                saveButton.disabled = false;
                
            } else {
                avgSystolicDisplay.textContent = '-';
                avgDiastolicDisplay.textContent = '-';
                avgPulseDisplay.textContent = '-';
                saveButton.disabled = true;
            }
        }

        document.querySelectorAll('#registroForm input[type="number"]').forEach(input => {
            input.addEventListener('input', calculateAndDisplayAverages);
        });


        document.getElementById('registroForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const avgSystolic = parseInt(document.getElementById('avgSystolicDisplay').textContent);
            const avgDiastolic = parseInt(document.getElementById('avgDiastolicDisplay').textContent);
            const avgPulse = parseInt(document.getElementById('avgPulseDisplay').textContent);
            const date = document.getElementById('dateTime').value; 

            if (isNaN(avgSystolic) || isNaN(avgDiastolic) || isNaN(avgPulse) || avgSystolic <= 0 || !date) {
                showMessage("Por favor, rellena las 3 tomas y la fecha con valores válidos.", 'error');
                return;
            }

            const newRecord = {
                date: date, 
                systolic: avgSystolic,
                diastolic: avgDiastolic,
                pulse: avgPulse
            };

            addRecordToLocal(newRecord);

            // Limpiar formulario, restablecer fecha/hora y promedios
            document.getElementById('registroForm').reset();
            setInitialDateTime();
            calculateAndDisplayAverages();
        });


        function deleteRecord(id) {
            showCustomModal(
                'Confirmar Eliminación',
                '¿Estás seguro de que deseas eliminar este registro? Se eliminará permanentemente de tu historial local.',
                [
                    { text: 'Cancelar', class: 'bg-gray-200 text-gray-700 hover:bg-gray-300', action: hideCustomModal },
                    { text: 'Eliminar', class: 'bg-red-600 text-white hover:bg-red-700', action: () => {
                        deleteRecordFromLocal(id);
                        hideCustomModal();
                        updateUIBasedOnData();
                    }}
                ]
            );
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('dataTableBody');
            const noDataMessage = document.getElementById('noDataHistory');
            
            tbody.innerHTML = ''; 

            if (pressureData.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }

            noDataMessage.classList.add('hidden');

            pressureData.forEach(record => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-indigo-50 transition duration-100';

                const dateCell = row.insertCell();
                dateCell.textContent = formatDateTime(record.date);
                dateCell.className = 'px-3 py-2 whitespace-nowrap text-gray-900';

                const systolicCell = row.insertCell();
                systolicCell.textContent = record.systolic;
                systolicCell.className = 'px-3 py-2 whitespace-nowrap font-medium';

                const diastolicCell = row.insertCell();
                diastolicCell.textContent = record.diastolic;
                diastolicCell.className = 'px-3 py-2 whitespace-nowrap';

                const pulseCell = row.insertCell();
                pulseCell.textContent = record.pulse;
                pulseCell.className = 'px-3 py-2 whitespace-nowrap';

                const actionCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                deleteButton.title = 'Eliminar registro';
                // El ID es el document ID generado localmente
                deleteButton.onclick = () => deleteRecord(record.id); 
                deleteButton.className = 'p-1 rounded-full hover:bg-red-100 transition duration-150';
                actionCell.appendChild(deleteButton);
                actionCell.className = 'px-3 py-2 text-center';
            });
        }

        // --- MANEJO DE GRÁFICOS (Chart.js) ---

        function renderChart() {
            const chartCanvas = document.getElementById('pressureChart');
            const noDataChart = document.getElementById('noDataChart');

            if (pressureData.length < 1) {
                if (pressureChart) {
                    pressureChart.destroy();
                    pressureChart = null;
                }
                chartCanvas.classList.add('hidden');
                noDataChart.classList.remove('hidden');
                return;
            }

            chartCanvas.classList.remove('hidden');
            noDataChart.classList.add('hidden');

            const chartData = pressureData.slice(0, 30).reverse(); 

            const labels = chartData.map(record => formatDateTime(record.date).split(' ')[0]); 
            const systolicValues = chartData.map(record => record.systolic);
            const diastolicValues = chartData.map(record => record.diastolic);
            const pulseValues = chartData.map(record => record.pulse);

            const minDiastolic = Math.min(...diastolicValues, 60);
            const maxPulse = Math.max(...pulseValues, 100);
            const minPulse = Math.min(...pulseValues, 50);

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Sistólica (Máx)',
                        data: systolicValues,
                        borderColor: 'rgb(79, 70, 229)', 
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        tension: 0.3,
                        pointRadius: 5,
                        yAxisID: 'y1',
                    },
                    {
                        label: 'Diastólica (Mín)',
                        data: diastolicValues,
                        borderColor: 'rgb(249, 115, 22)', 
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        tension: 0.3,
                        pointRadius: 5,
                        yAxisID: 'y1', 
                    },
                    {
                        label: 'Pulso (lpm)',
                        data: pulseValues,
                        borderColor: 'rgb(6, 95, 212)', 
                        backgroundColor: 'rgba(6, 95, 212, 0.2)',
                        tension: 0.3,
                        pointRadius: 5,
                        borderDash: [5, 5], 
                        yAxisID: 'y2', 
                    }
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 12 } } },
                        title: { display: true, text: 'Tensión y Pulso (Media de Tomas)' }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Fecha de Registro' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            min: minDiastolic - 10,
                            title: { display: true, text: 'Tensión (mmHg)' }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, 
                            min: minPulse - 10,
                            max: maxPulse + 10,
                            title: { display: true, text: 'Pulso (lpm)' }
                        }
                    }
                }
            };

            if (pressureChart) {
                pressureChart.destroy();
            }

            pressureChart = new Chart(chartCanvas, config);
        }

        // --- EXPORTACIÓN Y FILTRADO DE DATOS ---

        function getFilteredData() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            let filteredData = [...pressureData];

            if (startDateInput || endDateInput) {
                let start = startDateInput ? new Date(startDateInput + 'T00:00:00') : null;
                let end = endDateInput ? new Date(endDateInput + 'T23:59:59') : null;

                filteredData = filteredData.filter(record => {
                    const recordDate = new Date(record.date);

                    let isAfterStart = start ? recordDate >= start : true;
                    let isBeforeEnd = end ? recordDate <= end : true;

                    return isAfterStart && isBeforeEnd;
                });
            }

            // Ordenar ascendente por fecha para el PDF/Informe y JSON
            filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));

            return filteredData;
        }

        /**
         * Exporta los datos filtrados a un archivo JSON.
         * @param {boolean} [isAutomatic=false] - Indica si la exportación es automática.
         */
        function exportToJson(isAutomatic = false) {
            // El mapeo asegura que solo exportamos los datos esenciales (sin el ID local)
            const dataToExport = pressureData.map(record => ({
                date: record.date, 
                systolic: record.systolic,
                diastolic: record.diastolic,
                pulse: record.pulse
            })); 

            if (dataToExport.length === 0) {
                if (!isAutomatic) showMessage("No hay datos para exportar.", 'error');
                return;
            }

            // Generar sello de tiempo completo para el nombre del archivo
            const now = new Date();
            const datePart = now.toISOString().slice(0, 10); // YYYY-MM-DD
            const timePart = now.toLocaleTimeString('es-ES', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            }).replace(/:/g, '-'); // HH-MM-SS

            const fileName = `backup_tension_arterial_${datePart}_${timePart}.json`;

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (!isAutomatic) {
                 showMessage(`Exportados ${dataToExport.length} registros a: ${fileName}. Búscalo en tu carpeta de Descargas.`, 'success');
            } else {
                 console.log(`Backup automático generado: ${fileName} con ${dataToExport.length} registros.`);
            }
        }
        
        /**
         * Maneja la subida de un archivo JSON y llama a la importación.
         */
        function handleJsonImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showCustomModal(
                'Confirmar Importación',
                `¿Estás seguro de que quieres importar el archivo ${file.name}? Estos registros se añadirán a tu historial local.`,
                [
                    { text: 'Cancelar', class: 'bg-gray-200 text-gray-700 hover:bg-gray-300', action: hideCustomModal },
                    { text: 'Importar', class: 'bg-green-600 text-white hover:bg-green-700', action: () => {
                        importFromJson(file);
                        hideCustomModal();
                    }}
                ]
            );
            // Limpiar el input para permitir re-selección del mismo archivo
            event.target.value = '';
        }

        /**
         * Lee un archivo JSON y lo importa al localStorage.
         * @param {File} file - El archivo JSON cargado por el usuario.
         */
        function importFromJson(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        showMessage("El archivo JSON no contiene un formato de lista válido.", 'error');
                        return;
                    }

                    // Filtrar datos válidos y añadir un ID único a cada uno
                    const validRecords = importedData.filter(record => 
                        record.date && 
                        typeof record.systolic === 'number' && record.systolic > 0 && 
                        typeof record.diastolic === 'number' && record.diastolic > 0 && 
                        typeof record.pulse === 'number' && record.pulse > 0
                    ).map(record => ({
                        id: generateUUID(), // ¡Añadir ID único para poder borrarlo luego!
                        date: record.date,
                        systolic: record.systolic,
                        diastolic: record.diastolic,
                        pulse: record.pulse
                    }));

                    if (validRecords.length === 0) {
                        showMessage("No se encontraron registros válidos para importar en el archivo.", 'error');
                        return;
                    }

                    // Fusionar los datos importados con los existentes
                    // Nota: Esto puede crear duplicados si importas el mismo archivo.
                    pressureData = [...pressureData, ...validRecords];
                    pressureData.sort((a, b) => new Date(b.date) - new Date(a.date));

                    saveDataToLocal();
                    showMessage(`Se importaron ${validRecords.length} registros.`, 'success');
                    updateUIBasedOnData();

                } catch (error) {
                    console.error("Error al procesar o subir el JSON:", error);
                    showMessage("Error al leer o procesar el archivo de importación. Asegúrate de que el formato sea correcto.", 'error');
                }
            };
            reader.onerror = () => {
                showMessage("No se pudo leer el archivo.", 'error');
            };
            reader.readAsText(file);
        }

        // --- EXPORTACIÓN A PDF (jsPDF) ---
        
        function exportToPdf() {
            const dataToExport = getFilteredData();

            if (dataToExport.length === 0) {
                showMessage("No hay datos en el rango de fechas seleccionado para exportar a PDF.", 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const today = new Date().toLocaleDateString('es-ES');

            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            let rangeTitle = "Historial Completo";

            if (startDateInput || endDateInput) {
                const startText = startDateInput ? new Date(startDateInput).toLocaleDateString('es-ES') : 'Inicio';
                const endText = endDateInput ? new Date(endDateInput).toLocaleDateString('es-ES') : today;
                rangeTitle = `Rango de Fechas: ${startText} - ${endText}`;
            }

            let y = 20;

            doc.setFontSize(18);
            doc.setTextColor(55, 65, 81); 
            doc.text("Reporte de Tensión Arterial (Local)", 105, y, null, null, "center");
            y += 7;

            doc.setFontSize(12);
            doc.setTextColor(79, 70, 229); 
            doc.text(rangeTitle, 105, y, null, null, "center");
            y += 7;

            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text(`Generado el: ${today}`, 105, y, null, null, "center");
            y += 10;

            const headers = [["Fecha y Hora", "Sistólica (mmHg) Media", "Diastólica (mmHg) Media", "Pulso (lpm) Media"]];

            // Formatear los datos para jspdf-autotable
            const body = dataToExport.map(record => [
                formatDateTime(record.date),
                record.systolic.toString(),
                record.diastolic.toString(),
                record.pulse.toString()
            ]);

            // Usar autoTable (plugin de jspdf)
            doc.autoTable({
                head: headers,
                body: body,
                startY: y,
                styles: { fontSize: 9, cellPadding: 2, textColor: [51, 51, 51] },
                headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 244, 255] },
                margin: { top: 10, left: 10, right: 10, bottom: 10 },
            });

            const fileName = `reporte_tension_arterial_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);
        }

        // --- MODAL PERSONALIZADO ---

        function showCustomModal(title, message, buttons) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            
            const buttonContainer = document.getElementById('modalButtons');
            buttonContainer.innerHTML = '';

            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = `py-2 px-4 rounded-lg shadow-md text-sm font-medium transition duration-150 ${btn.class}`;
                buttonElement.onclick = btn.action;
                buttonContainer.appendChild(buttonElement);
            });

            modal.classList.remove('hidden');
        }

        function hideCustomModal() {
            document.getElementById('customModal').classList.add('hidden');
        }

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            setInitialDateTime();
            calculateAndDisplayAverages(); // Inicializa los promedios y deshabilita el botón
            loadDataFromLocal(); // Cargar los datos guardados al inicio
            showSection('registro'); // Asegura que se muestre la pestaña de registro por defecto
        };
    </script>
</body>
</html>
